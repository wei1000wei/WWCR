# WWCR 聊天应用功能增强实现计划

## 实现范围

用户要求实现以下功能：
1.1 多文件上传
1.2 文件预览功能
1.4 上传进度条优化
2 消息回复/引用
12.2 群头像和描述
2.3 消息标记已读/未读
2.4 消息搜索
3.1 深色模式
3.4 加载动画
4.1 群公告
4.3 成员角色细化
5.2 防刷屏机制
6.1 个人资料编辑
6.3 离线消息
6.4 系统设置

## 实现计划

### 第一阶段：文件相关功能增强

#### 1.1 多文件上传
- **前端修改**：
  - 修改 `frontend/index.html` 中的文件输入框，添加 `multiple` 属性
  - 更新 `frontend/js/chat.js` 中的 `handleFileSelect` 和 `uploadFile` 函数，支持多文件处理
- **后端修改**：
  - 修改 `backend/routes/messages.js` 中的上传路由，使用 `upload.array('files')` 处理多文件上传
  - 循环处理每个上传的文件，为每个文件创建单独的消息

#### 1.2 文件预览功能
- **前端修改**：
  - 在 `frontend/js/chat.js` 中的 `addMessageToDOM` 函数中添加文件类型检测
  - 根据文件类型生成不同的预览：图片显示缩略图，视频/音频显示播放器
  - 添加预览相关的 CSS 样式

#### 1.4 上传进度条优化
- **前端修改**：
  - 修改 `frontend/js/chat.js` 中的 `uploadFile` 函数，使用 XMLHttpRequest 或 Fetch API 的 progress 事件
  - 实时更新上传进度条的显示

### 第二阶段：消息功能增强

#### 2 消息回复/引用
- **后端修改**：
  - 修改 `backend/models/Message.js`，添加 `replyTo` 字段关联被回复的消息
  - 更新消息路由，支持回复消息的创建和查询
- **前端修改**：
  - 在 `frontend/js/chat.js` 中添加回复按钮和引用消息的显示逻辑
  - 实现回复消息的发送和显示

#### 2.3 消息标记已读/未读
- **后端修改**：
  - 修改 `backend/models/Message.js`，添加 `readStatus` 字段记录每个用户的阅读状态
  - 添加消息标记已读的路由
- **前端修改**：
  - 在 `frontend/js/chat.js` 中添加未读消息标记和计数显示
  - 实现消息标记已读的功能

#### 2.4 消息搜索
- **后端修改**：
  - 在 `backend/routes/messages.js` 中添加消息搜索路由，支持按关键词、时间范围等条件搜索
- **前端修改**：
  - 在 `frontend/index.html` 中添加搜索框
  - 在 `frontend/js/chat.js` 中实现搜索功能和结果显示

### 第三阶段：用户体验优化

#### 3.1 深色模式
- **前端修改**：
  - 在 `frontend/css/style.css` 中添加 CSS 变量定义，管理主题颜色
  - 在 `frontend/index.html` 中添加主题切换按钮
  - 在 `frontend/js/main.js` 中实现主题切换功能

#### 3.4 加载动画
- **前端修改**：
  - 在 `frontend/css/style.css` 中添加各种加载动画的样式
  - 在 `frontend/js/chat.js` 和 `frontend/js/main.js` 中添加加载状态的显示和隐藏逻辑

### 第四阶段：群组管理增强

#### 12.2 群头像和描述
- **后端修改**：
  - 修改 `backend/models/Group.js`，添加 `avatar` 和 `description` 字段
  - 添加群头像上传和群描述编辑的路由
- **前端修改**：
  - 在 `frontend/index.html` 中的群组设置中添加头像上传和描述编辑功能
  - 在 `frontend/js/main.js` 中实现群头像和描述的编辑逻辑

#### 4.1 群公告
- **后端修改**：
  - 修改 `backend/models/Group.js`，添加 `announcement` 字段
  - 添加群公告编辑的路由
- **前端修改**：
  - 在 `frontend/index.html` 中的群组设置中添加公告编辑功能
  - 在 `frontend/js/main.js` 中实现群公告的编辑和显示逻辑

#### 4.3 成员角色细化
- **后端修改**：
  - 修改 `backend/models/Group.js`，扩展成员角色字段，支持更多角色类型
  - 更新群组管理路由，支持角色的分配和管理
- **前端修改**：
  - 在 `frontend/index.html` 中的群组设置中添加角色管理界面
  - 在 `frontend/js/main.js` 中实现角色管理的逻辑

### 第五阶段：安全和性能

#### 5.2 防刷屏机制
- **后端修改**：
  - 在 `backend/middleware/` 中创建 `rateLimit.js` 中间件，限制单位时间内的消息发送频率
  - 在消息路由中应用此中间件

### 第六阶段：其他功能

#### 6.1 个人资料编辑
- **后端修改**：
  - 修改 `backend/models/User.js`，添加头像、昵称、简介等字段
  - 添加个人资料编辑的路由
- **前端修改**：
  - 创建 `frontend/profile.html` 页面，用于个人资料编辑
  - 在 `frontend/js/main.js` 中添加个人资料编辑的逻辑

#### 6.3 离线消息
- **后端修改**：
  - 优化消息存储和同步机制，确保用户离线时消息不会丢失
  - 添加离线消息同步的路由
- **前端修改**：
  - 在 `frontend/js/chat.js` 中实现离线消息的同步和显示逻辑

#### 6.4 系统设置
- **后端修改**：
  - 修改 `backend/models/User.js`，添加设置字段，存储用户的系统设置偏好
  - 添加系统设置编辑的路由
- **前端修改**：
  - 创建 `frontend/settings.html` 页面，用于系统设置
  - 在 `frontend/js/main.js` 中实现系统设置的编辑和应用逻辑

## 实现顺序

1. 第一阶段：文件相关功能增强
2. 第二阶段：消息功能增强
3. 第三阶段：用户体验优化
4. 第四阶段：群组管理增强
5. 第五阶段：安全和性能
6. 第六阶段：其他功能

## 技术要点

- **前端**：使用原生 JavaScript 和 CSS，确保代码的兼容性和可维护性
- **后端**：使用 Node.js 和 Express，确保 API 的安全性和性能
- **数据库**：使用 MongoDB 和 Mongoose，确保数据的一致性和可靠性
- **实时通信**：使用 Socket.io，确保消息的实时传递
- **用户体验**：注重界面的美观性和交互的流畅性

## 预期效果

通过实现这些功能，WWCR 聊天应用将变得更加功能完善、用户友好，能够满足更多场景的需求，提升用户的整体体验。