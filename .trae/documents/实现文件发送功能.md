# 文件发送功能实现计划

## 1. 后端修改

### 1.1 修改 Message 模型
- 在 `backend/models/Message.js` 中添加文件相关字段：
  - `fileUrl`: 存储文件的访问路径
  - `fileName`: 存储文件的原始名称
  - `fileSize`: 存储文件的大小
  - `fileType`: 存储文件的 MIME 类型

### 1.2 配置文件存储
- 在 `backend/config/` 中创建 `upload.js` 配置文件
- 使用 multer 配置文件上传，设置文件存储路径为 `backend/uploads/`
- 限制文件大小（建议 10MB）
- 配置文件类型过滤

### 1.3 添加文件上传路由
- 在 `backend/routes/messages.js` 中添加文件上传路由
- 实现文件上传的处理逻辑
- 生成文件的访问路径
- 创建包含文件信息的消息

### 1.4 修改消息发送逻辑
- 更新消息发送路由，支持文件消息
- 确保文件消息能够通过 Socket.io 实时发送给群组内的所有成员

## 2. 前端修改

### 2.1 修改聊天界面
- 在 `frontend/home.html` 中修改消息表单，添加文件上传按钮
- 添加文件选择输入框（隐藏）
- 添加文件上传进度显示

### 2.2 更新 chat.js
- 添加文件上传相关的 DOM 元素引用
- 实现文件选择功能
- 实现文件上传功能，使用 FormData 发送文件
- 修改消息渲染逻辑，支持文件消息的显示
- 添加文件下载功能
- 确保文件消息能够实时接收和显示

### 2.3 更新消息渲染
- 在 `addMessageToDOM` 函数中添加文件消息的渲染逻辑
- 显示文件图标、文件名、文件大小
- 添加文件下载链接

## 3. 安全考虑

### 3.1 文件上传安全
- 验证文件类型，只允许上传安全的文件类型
- 限制文件大小，防止恶意上传大文件
- 重命名上传的文件，使用随机文件名，防止文件名冲突和路径遍历攻击
- 扫描上传的文件，防止恶意文件

### 3.2 文件访问控制
- 确保只有群组内的成员能够访问上传的文件
- 实现文件访问的权限检查

## 4. 测试

### 4.1 功能测试
- 测试文件上传功能
- 测试文件消息的发送和接收
- 测试文件下载功能
- 测试不同类型文件的处理

### 4.2 性能测试
- 测试大文件上传的性能
- 测试多个文件同时上传的性能

### 4.3 安全测试
- 测试文件上传的安全性
- 测试文件访问的权限控制

## 5. 实现步骤

1. 创建文件存储目录 `backend/uploads/`
2. 修改 `Message` 模型，添加文件相关字段
3. 配置 multer 中间件，处理文件上传
4. 添加文件上传路由
5. 修改消息发送逻辑，支持文件消息
6. 修改前端聊天界面，添加文件上传按钮
7. 更新 `chat.js`，实现文件上传和处理功能
8. 测试文件发送功能
9. 优化和修复问题

## 6. 预期效果

- 用户可以在聊天界面选择并上传文件
- 上传的文件会显示在聊天记录中，包含文件图标、文件名和文件大小
- 群组内的所有成员能够实时看到文件消息
- 用户可以点击文件消息下载文件
- 系统会限制文件大小和类型，确保安全

## 7. 技术要点

- 使用 multer 处理文件上传
- 使用 FormData 发送文件
- 修改 MongoDB 模型，存储文件信息
- 通过 Socket.io 实时发送文件消息
- 实现文件访问控制，确保安全
- 优化文件上传和下载的用户体验